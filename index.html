<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SIDALI – Sistem Digitalisasi Kecamatan Kabupaten Tapanuli Selatan</title>
  <meta name="description" content="SIDALI – SISTEM DIGITALISASI KECAMATAN KABUPATEN TAPANULI SELATAN" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Chart.js for infographics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --emas:#D4AF37;           /* emas klasik */
      --emas-soft:#f5e7bf;      /* highlight lembut */
      --hijau:#0e7a43;          /* hijau Tapsel */
      --hijau-soft:#e6f4ec;     /* latar lembut */
      --gelap:#0b1d14;
    }
    html,body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    /* Glassy cards */
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.75));backdrop-filter:saturate(140%) blur(8px);}
    .ring-emas{box-shadow:0 0 0 2px var(--emas) inset}
    /* Animated underline for tabs */
    .tab-active{position:relative}
    .tab-active:after{content:"";position:absolute;left:0;right:0;bottom:-10px;height:3px;background:linear-gradient(90deg,var(--emas),var(--hijau));border-radius:999px}
    /* Fancy scrollbar */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--emas),var(--hijau));border-radius:999px}
  </style>
</head>
<body class="min-h-screen bg-[conic-gradient(at_120%_-20%,_#ffffff,_#ffffff,_#f9fafb_45%,_#f4f4f4_60%,_#ffffff)]">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 border-b border-emerald-100/70 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-4">
      <img id="appLogo" alt="Logo SIDALI" class="h-12 w-12 rounded-xl ring-1 ring-emerald-200 object-contain"
           src="./assets/img/sidali.png" alt="Logo SIDALI"sidali.png"/>
      <div class="flex-1">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight text-emerald-900">SIDALI
          <span class="font-light text-emerald-700">— SISTEM DIGITALISASI KECAMATAN KABUPATEN TAPANULI SELATAN</span>
        </h1>
        <p class="text-xs sm:text-sm text-emerald-700/80">Elegan • Modern • Transparan • BerAKHLAK</p>
      </div>
      <button id="themeToggle" class="hidden sm:inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm border border-emerald-200 hover:border-emerald-300 bg-white shadow-sm">
        <i data-lucide="sun"></i><span>Mode Terang</span>
      </button>
    </div>
  </header>

  <!-- Hero / Nav Tabs -->
  <section class="border-b border-emerald-100/60 bg-gradient-to-r from-emerald-50 to-emerald-100/30">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 flex flex-wrap items-center justify-between gap-4">
      <nav class="flex flex-wrap gap-2" id="tabsNav" aria-label="Navigasi Tab">
        <button data-tab="tab-deskripsi" class="tab-btn tab-active rounded-2xl px-4 py-2 text-sm sm:text-base font-medium bg-white shadow hover:shadow-md border border-emerald-100">Deskripsi Wilayah</button>
        <button data-tab="tab-kegiatan" class="tab-btn rounded-2xl px-4 py-2 text-sm sm:text-base font-medium bg-white shadow hover:shadow-md border border-emerald-100">Kegiatan Kecamatan</button>
        <button data-tab="tab-pengumuman" class="tab-btn rounded-2xl px-4 py-2 text-sm sm:text-base font-medium bg-white shadow hover:shadow-md border border-emerald-100">Pengumuman</button>
        <button data-tab="tab-data" class="tab-btn rounded-2xl px-4 py-2 text-sm sm:text-base font-medium bg-white shadow hover:shadow-md border border-emerald-100">Data Camat, Lurah & Kepling</button>
        <button data-tab="tab-bantuan" class="tab-btn rounded-2xl px-4 py-2 text-sm sm:text-base font-medium bg-white shadow hover:shadow-md border border-emerald-100">Bantuan</button>
      </nav>
      <div class="flex items-center gap-2 text-xs sm:text-sm text-emerald-900/80">
        <i data-lucide="shield-check"></i>
        <span>Terintegrasi • Open‑Source • Siap GitHub Pages</span>
      </div>
    </div>
  </section>

  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <!-- TAB: DESKRIPSI WILAYAH -->
    <section id="tab-deskripsi" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="glass rounded-2xl p-5 border border-emerald-100 shadow-sm">
          <p class="text-xs text-emerald-700/80">Luas Wilayah</p>
          <div class="mt-2 flex items-end justify-between">
            <h3 id="statLuas" class="text-3xl font-semibold text-emerald-900">0</h3>
            <span class="text-xs px-2 py-1 rounded-full border border-yellow-300 bg-yellow-50 text-yellow-800">km²</span>
          </div>
        </div>
        <div class="glass rounded-2xl p-5 border border-emerald-100 shadow-sm">
          <p class="text-xs text-emerald-700/80">Jumlah Penduduk</p>
          <div class="mt-2 flex items-end justify-between">
            <h3 id="statPenduduk" class="text-3xl font-semibold text-emerald-900">0</h3>
            <span class="text-xs px-2 py-1 rounded-full border border-yellow-300 bg-yellow-50 text-yellow-800">jiwa</span>
          </div>
        </div>
        <div class="glass rounded-2xl p-5 border border-emerald-100 shadow-sm">
          <p class="text-xs text-emerald-700/80">Jumlah Kecamatan</p>
          <div class="mt-2 flex items-end justify-between">
            <h3 id="statKec" class="text-3xl font-semibold text-emerald-900">0</h3>
            <span class="text-xs px-2 py-1 rounded-full border border-yellow-300 bg-yellow-50 text-yellow-800">kec</span>
          </div>
        </div>
        <div class="glass rounded-2xl p-5 border border-emerald-100 shadow-sm">
          <p class="text-xs text-emerald-700/80">Jumlah Kelurahan/Desa</p>
          <div class="mt-2 flex items-end justify-between">
            <h3 id="statKel" class="text-3xl font-semibold text-emerald-900">0</h3>
            <span class="text-xs px-2 py-1 rounded-full border border-yellow-300 bg-yellow-50 text-yellow-800">kel/des</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <article class="lg:col-span-3 glass rounded-2xl p-6 border border-emerald-100 shadow-sm">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-emerald-900">Ringkasan Kabupaten Tapanuli Selatan</h2>
            <span class="text-xs text-emerald-700/70" id="lastUpdated"></span>
          </div>
          <p class="mt-3 text-sm leading-relaxed text-emerald-800/90" id="ringkasan">
            Isi ringkasan singkat wilayah—sejarah, potensi, dan karakteristik. Edit cepat melalui tombol “Sesuaikan Data” di bawah.
          </p>
          <div class="mt-4 flex flex-wrap gap-2">
            <button class="text-xs rounded-xl border border-emerald-200 px-3 py-1.5 bg-white hover:bg-emerald-50" onclick="openEditor()">Sesuaikan Data</button>
          </div>
        </article>
        <article class="lg:col-span-2 glass rounded-2xl p-6 border border-emerald-100 shadow-sm">
          <h2 class="text-lg font-semibold text-emerald-900">Komposisi Penduduk</h2>
          <canvas id="chartPenduduk" class="mt-4"></canvas>
        </article>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <article class="glass rounded-2xl p-6 border border-emerald-100 shadow-sm">
          <h2 class="text-lg font-semibold text-emerald-900">Sebaran Kecamatan</h2>
          <canvas id="chartKec"></canvas>
        </article>
        <article class="glass rounded-2xl p-6 border border-emerald-100 shadow-sm">
          <h2 class="text-lg font-semibold text-emerald-900">Pertumbuhan Penduduk Tahunan</h2>
          <canvas id="chartGrowth"></canvas>
        </article>
      </div>
    </section>

    <!-- TAB: KEGIATAN KECAMATAN -->
    <section id="tab-kegiatan" class="space-y-5 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-emerald-900">Unggah Kegiatan Kecamatan</h2>
        <span class="text-xs rounded-full border border-yellow-300 bg-yellow-50 text-yellow-800 px-2 py-1">Status: <b id="statusKirim">Menunggu</b></span>
      </div>

      <form id="formKegiatan" class="grid grid-cols-1 lg:grid-cols-5 gap-6" enctype="multipart/form-data">
        <div class="lg:col-span-3 glass rounded-2xl p-6 border border-emerald-100 shadow-sm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="text-sm">Nama Penanggung Jawab
              <input id="fNama" required class="mt-1 input w-full rounded-xl border border-emerald-200/70 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="Nama lengkap" />
            </label>
            <label class="text-sm">Tanggal
              <input id="fTanggal" type="date" required class="mt-1 w-full rounded-xl border border-emerald-200/70 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300" />
            </label>
            <label class="text-sm">Kecamatan
              <input id="fKec" required class="mt-1 w-full rounded-xl border border-emerald-200/70 bg-white px-3 py-2" placeholder="Contoh: Batang Toru" />
            </label>
            <label class="text-sm md:col-span-2">Deskripsi
              <textarea id="fDesk" required rows="4" class="mt-1 w-full rounded-xl border border-emerald-200/70 bg-white px-3 py-2" placeholder="Uraian singkat kegiatan"></textarea>
            </label>
          </div>
        </div>
        <div class="lg:col-span-2 glass rounded-2xl p-6 border border-emerald-100 shadow-sm">
          <label class="text-sm">Lampiran Bukti (foto/pdf)
            <input id="fLampiran" type="file" accept="image/*,application/pdf" required class="mt-2 block w-full text-sm file:mr-4 file:rounded-lg file:border-0 file:bg-emerald-600 file:px-4 file:py-2 file:text-white hover:file:bg-emerald-700" />
          </label>
          <p class="mt-3 text-xs text-emerald-700/80">File akan dikirim ke Google Drive melalui endpoint Apps Script yang Anda sediakan.</p>
          <div class="mt-4 flex gap-2">
            <button class="rounded-xl bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700" type="submit">Kirim</button>
            <button class="rounded-xl border border-emerald-200 px-4 py-2 text-emerald-900 hover:bg-emerald-50" type="reset">Reset</button>
          </div>
        </div>
      </form>

      <div class="text-xs text-emerald-700/80">Endpoint saat ini: <code id="endpointShown" class="rounded-md bg-emerald-50 px-2 py-1 border border-emerald-100">(belum disetel)</code>
        <button onclick="setEndpointPrompt()" class="ml-2 text-emerald-800 underline hover:text-emerald-600">Setel</button>
      </div>
    </section>

    <!-- TAB: PENGUMUMAN -->
    <section id="tab-pengumuman" class="space-y-5 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-emerald-900">Pengumuman Kegiatan</h2>
        <button class="text-sm rounded-xl border border-emerald-200 px-3 py-1.5 bg-white hover:bg-emerald-50" onclick="muatPengumuman(true)">Muat Ulang</button>
      </div>
      <div id="listPengumuman" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p class="text-xs text-emerald-700/70">Sumber data: hasil unggahan dari tab “Kegiatan Kecamatan”.</p>
    </section>

    <!-- TAB: DATA CAMAT, LURAH & KEPLING -->
    <section id="tab-data" class="space-y-5 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-emerald-900">Data Camat, Lurah, dan Kepling</h2>
        <div class="text-xs text-emerald-700/80">Sumber: Google Spreadsheet (read‑only)</div>
      </div>
      <div class="glass rounded-2xl border border-emerald-100 shadow-sm overflow-hidden">
        <iframe title="Data Camat, Lurah dan Kepling" class="w-full h-[70vh]" style="border:0"
          src="https://docs.google.com/spreadsheets/d/1m3jITIs6dLgWQBrLwt-uKWHbGR8O88s1RNzmGQVwwJo/preview#gid=0"></iframe>
      </div>
    </section>

    <!-- TAB: BANTUAN / DOKUMENTASI CEPAT -->
    <section id="tab-bantuan" class="space-y-4 hidden">
      <h2 class="text-lg font-semibold text-emerald-900">Panduan Integrasi Google Drive (Apps Script)</h2>
      <ol class="list-decimal pl-5 space-y-2 text-sm text-emerald-900/90">
        <li>Buka <b>script.new</b> (Google Apps Script) → ganti Project type menjadi <em>Web App</em>.</li>
        <li>Tempel kode Apps Script di bawah ini, <em>Deploy</em> sebagai Web App: <b>Anyone with the link</b>.</li>
        <li>Salin URL Web App dan tekan tombol <b>Setel</b> di tab “Kegiatan Kecamatan”, lalu kirim uji coba.</li>
        <li>Opsional: simpan metadata ke Google Sheet agar dapat ditarik oleh tab “Pengumuman”.</li>
      </ol>
      <details class="glass rounded-2xl border border-emerald-100 shadow-sm p-4">
        <summary class="cursor-pointer font-medium text-emerald-900">Kode Google Apps Script (simpan file ke Drive + catat ke Sheet)</summary>
        <pre class="mt-3 text-xs leading-6 overflow-x-auto"><code>// === Apps Script: doPost untuk menerima form & file ===
function doPost(e){
  try{
    var data = Utilities.parseMultipart(e);
    var folder = DriveApp.getFolderById('FOLDER_ID_DRIVE'); // ganti ke folder tujuan

    var blob = data.files[0]; // file pertama
    var file = folder.createFile(blob);

    var nama = data.fields.fNama || '';
    var tanggal = data.fields.fTanggal || '';
    var kec = data.fields.fKec || '';
    var desk = data.fields.fDesk || '';

    // Tulis ke Google Sheet (opsional)
    var sheet = SpreadsheetApp.openById('SHEET_ID').getSheetByName('Data');
    sheet.appendRow([new Date(), nama, tanggal, kec, desk, file.getName(), file.getUrl()]);

    return ContentService.createTextOutput(JSON.stringify({
      ok:true,
      message:'Tersimpan di Drive',
      fileUrl:file.getUrl()
    })).setMimeType(ContentService.MimeType.JSON);
  }catch(err){
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:String(err)}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// === Apps Script: doGet?action=list untuk baca pengumuman dari Sheet ===
function doGet(e){
  var action = (e.parameter.action||'').toLowerCase();
  if(action=='list'){
    var sheet = SpreadsheetApp.openById('SHEET_ID').getSheetByName('Data');
    var values = sheet.getDataRange().getValues();
    var out = [];
    for(var i=1;i<values.length;i++){
      var r = values[i];
      out.push({
        created:r[0], nama:r[1], tanggal:r[2], kecamatan:r[3], deskripsi:r[4], bukti:r[6]
      });
    }
    return ContentService.createTextOutput(JSON.stringify({ok:true,data:out}))
      .setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput('SIDALI API');
}

// Utility parse multipart
Utilities.parseMultipart = function(e){
  var cType = e.postData.type;
  var parts = Utilities.parseMultipartFormData(e.postData.contents, cType);
  var fields = {}, files=[];
  parts.forEach(function(p){
    if(p.fileName){ files.push(Utilities.newBlob(p.bytes, p.contentType, p.fileName)); }
    else{ fields[p.name] = p.value; }
  });
  return {fields:fields, files:files};
}
</code></pre>
        <p class="mt-3 text-xs text-emerald-800/90">Buat Google Sheet dengan sheet bernama <b>Data</b> (header bebas). Ganti <code>FOLDER_ID_DRIVE</code> dan <code>SHEET_ID</code> sesuai kebutuhan.</p>
      </details>
    </section>
  </main>

  <footer class="mt-10 border-t border-emerald-100/70 bg-white/60">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 flex flex-wrap items-center justify-between gap-3">
      <p class="text-xs text-emerald-800">© <span id="y"></span> Pemerintah Kabupaten Tapanuli Selatan • SIDALI</p>
      <div class="flex items-center gap-3 text-xs">
        <span class="px-2 py-1 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-900">Putih‑Emas‑Hijau</span>
        <span class="px-2 py-1 rounded-full border border-yellow-300 bg-yellow-50 text-yellow-900">BerAKHLAK</span>
      </div>
    </div>
  </footer>

  <script>
    // ===== Icons
  lucide.createIcons();

  // ===== Theme toggle (demo only)
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('bg-white');
    });
  }

  // ===== Tabs logic
  const btns = document.querySelectorAll('.tab-btn');
  const sections = [
    'tab-deskripsi',
    'tab-kegiatan',
    'tab-pengumuman',
    'tab-data',
    'tab-bantuan'
  ].map(id => document.getElementById(id));

  btns.forEach(b => b.addEventListener('click', () => {
    btns.forEach(x => x.classList.remove('tab-active'));
    b.classList.add('tab-active');
    sections.forEach(s => s.classList.add('hidden'));
    document.getElementById(b.dataset.tab).classList.remove('hidden');
    // render pengumuman saat pertama buka
    if (b.dataset.tab === 'tab-pengumuman') { muatPengumuman(); }
  }));

  // ===== Data demo yang dapat disesuaikan
  const dataWilayah = JSON.parse(localStorage.getItem('sidali:dataWilayah') || 'null') || {
    luas: 6100,
    penduduk: 320000,
    kec: 15,
    kel: 248,
    ringkasan: 'Kabupaten Tapanuli Selatan memiliki potensi pertanian, perkebunan, pariwisata alam serta pertambangan. Pemerintahan daerah mendorong layanan publik digital dan kolaborasi lintas kecamatan.'
  };

  function formatNumber(n) { return new Intl.NumberFormat('id-ID').format(n); }

  function renderStats() {
    document.getElementById('statLuas').textContent = formatNumber(dataWilayah.luas);
    document.getElementById('statPenduduk').textContent = formatNumber(dataWilayah.penduduk);
    document.getElementById('statKec').textContent = formatNumber(dataWilayah.kec);
    document.getElementById('statKel').textContent = formatNumber(dataWilayah.kel);
    document.getElementById('ringkasan').textContent = dataWilayah.ringkasan;
    document.getElementById('lastUpdated').textContent =
      'Terakhir diperbarui: ' + new Date().toLocaleString('id-ID');
  }

  function openEditor() {
    const luas = prompt('Luas wilayah (km²):', dataWilayah.luas);
    const pend = prompt('Jumlah penduduk:', dataWilayah.penduduk);
    const kec = prompt('Jumlah kecamatan:', dataWilayah.kec);
    const kel = prompt('Jumlah kel/desa:', dataWilayah.kel);
    const ring = prompt('Ringkasan singkat:', dataWilayah.ringkasan);
    if (luas && pend && kec && kel && ring) {
      dataWilayah.luas = +luas;
      dataWilayah.penduduk = +pend;
      dataWilayah.kec = +kec;
      dataWilayah.kel = +kel;
      dataWilayah.ringkasan = ring;
      localStorage.setItem('sidali:dataWilayah', JSON.stringify(dataWilayah));
      renderStats();
      drawCharts();
    }
  }
  window.openEditor = openEditor;

  // ===== Charts
  let c1, c2, c3;
  function drawCharts() {
    [c1, c2, c3].forEach(x => x && x.destroy());
    const ctx1 = document.getElementById('chartPenduduk');
    const ctx2 = document.getElementById('chartKec');
    const ctx3 = document.getElementById('chartGrowth');

    c1 = new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: ['Usia Produktif', 'Usia Non-Produktif'],
        datasets: [{
          data: [
            Math.round(dataWilayah.penduduk * 0.67),
            Math.round(dataWilayah.penduduk * 0.33)
          ],
          borderWidth: 0
        }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    c2 = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: ['Kec 1', 'Kec 2', 'Kec 3', 'Kec 4', 'Kec 5', 'Kec 6'],
        datasets: [{
          label: 'Penduduk/10k',
          data: [12, 8, 10, 6, 9, 7],
          borderWidth: 0
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    c3 = new Chart(ctx3, {
      type: 'line',
      data: {
        labels: ['2019', '2020', '2021', '2022', '2023', '2024'],
        datasets: [{
          label: 'Pertumbuhan (%)',
          data: [1.1, 1.0, 0.9, 1.2, 1.3, 1.1],
          fill: false,
          tension: .3,
          borderWidth: 2
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: false } }
      }
    });
  }

  // ====== KONFIGURASI MASTER KEGIATAN & PENGUMUMAN
  // Endpoint Apps Script (file master Kegiatan Kecamatan)
  const DEFAULT_ENDPOINT =
    'https://script.google.com/macros/s/AKfycby4Ton6DuKWUYk5tjlTMRipla4nyoti0zj89M3nBnp-S3Rdvm68hv8wm_isdwDcoKk0Fw/exec';

  // Link CSV master sheet Pengumuman
  const SHEET_CSV_URL =
    'https://docs.google.com/spreadsheets/d/1dVejLEpBx_ypeKR6o3F26ebX-jKRwPRZhNV2KOXW2V8/export?format=csv&gid=0';

  // ===== Form submit ke Apps Script (Drive + Sheet master)
  const form = document.getElementById('formKegiatan');
  const statusKirim = document.getElementById('statusKirim');
  const endpointShown = document.getElementById('endpointShown');

  const APPS_SCRIPT_URL =
    localStorage.getItem('sidali:endpoint') || DEFAULT_ENDPOINT;

  if (endpointShown && APPS_SCRIPT_URL) {
    endpointShown.textContent = APPS_SCRIPT_URL;
  }

  function setEndpointPrompt() {
    const url = prompt(
      'Tempel URL Web App (Apps Script):',
      localStorage.getItem('sidali:endpoint') || APPS_SCRIPT_URL
    );
    if (url) {
      localStorage.setItem('sidali:endpoint', url);
      if (endpointShown) endpointShown.textContent = url;
      alert('Endpoint disetel.');
    }
  }
  window.setEndpointPrompt = setEndpointPrompt;

  form && form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = localStorage.getItem('sidali:endpoint') || DEFAULT_ENDPOINT;

    try {
      statusKirim.textContent = 'Mengirim…';

      const fd = new FormData();
      fd.append('fNama', document.getElementById('fNama').value.trim());
      fd.append('fTanggal', document.getElementById('fTanggal').value);
      fd.append('fKec', document.getElementById('fKec').value.trim());
      fd.append('fDesk', document.getElementById('fDesk').value.trim());

      const file = document.getElementById('fLampiran').files[0];
      if (file) {
        // "file" harus sama dengan parameter di Apps Script
        fd.append('file', file, file.name);
      }

      const res = await fetch(url, {
        method: 'POST',
        body: fd
      });

      let out = {};
      try {
        out = await res.json();
      } catch (_) {
        // kalau bukan JSON, anggap saja berhasil bila status OK
        out = { ok: res.ok };
      }

      if (!res.ok || out.ok === false) {
        throw new Error(out.error || ('Status HTTP ' + res.status));
      }

      statusKirim.textContent = 'Terkirim';
      form.reset();
      alert('Kegiatan tersimpan di master sheet.');
      // refresh tampilan pengumuman dari master sheet
      muatPengumuman();
    } catch (err) {
      statusKirim.textContent = 'Gagal';
      alert('Gagal mengirim: ' + err.message);
    }
  });

  // ===== Utility kecil
  function escapeHtml(str) {
    return String(str).replace(/[&<>"]/g, s => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;'
    }[s]));
  }

  function formatTanggal(s) {
    try {
      return new Date(s).toLocaleDateString('id-ID', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    } catch {
      return s;
    }
  }

  // Parser CSV sederhana (support tanda kutip)
  function parseCSV(text) {
    const rows = [];
    let cur = '';
    let row = [];
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (c === '"') {
        if (inQuotes && text[i + 1] === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (c === ',' && !inQuotes) {
        row.push(cur);
        cur = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (cur !== '' || row.length) {
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
        }
      } else {
        cur += c;
      }
    }
    if (cur !== '' || row.length) {
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  // ===== Muat Pengumuman dari master CSV
  async function muatPengumuman() {
    const cont = document.getElementById('listPengumuman');
    if (!cont) return;

    cont.innerHTML =
      '<p class="text-sm text-emerald-700/80">Memuat data pengumuman dari master sheet...</p>';

    try {
      const resp = await fetch(SHEET_CSV_URL);
      if (!resp.ok) {
        throw new Error('HTTP ' + resp.status);
      }
      const text = await resp.text();
      const rows = parseCSV(text);

      // Asumsi struktur: [0]=timestamp, [1]=nama, [2]=tanggal,
      // [3]=kecamatan, [4]=deskripsi, [5]=namaFile, [6]=url bukti
      if (!rows || rows.length <= 1) {
        cont.innerHTML =
          '<p class="text-sm text-emerald-700/80">Belum ada pengumuman di master sheet.</p>';
        return;
      }

      cont.innerHTML = '';
      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r || !r.length || r.join('').trim() === '') continue;

        const created = r[0] || '';
        const nama = r[1] || '';
        const tanggal = r[2] || created;
        const kecamatan = r[3] || '';
        const deskripsi = r[4] || '';
        const bukti = r[6] || '';

        const card = document.createElement('article');
        card.className =
          'glass rounded-2xl p-4 border border-emerald-100 shadow-sm flex flex-col gap-2';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-emerald-900">${escapeHtml(kecamatan || '-')}</h3>
            <span class="text-xs text-emerald-700/70">${formatTanggal(tanggal)}</span>
          </div>
          <p class="text-sm text-emerald-900/90"><b>${escapeHtml(nama || '-')}</b></p>
          <p class="text-sm text-emerald-900/90">${escapeHtml(deskripsi || '-')}</p>
          ${bukti
            ? `<a class="mt-1 inline-flex items-center gap-2 text-sm text-emerald-800 underline" href="${bukti}" target="_blank" rel="noopener">
                 Lihat Bukti<i data-lucide="external-link" class="w-4 h-4"></i>
               </a>`
            : ''
          }
        `;
        cont.appendChild(card);
      }

      lucide.createIcons();
    } catch (err) {
      cont.innerHTML =
        '<p class="text-sm text-red-700/80">Gagal memuat pengumuman dari master sheet: ' +
        escapeHtml(err.message) + '</p>';
    }
  }
  window.muatPengumuman = muatPengumuman;

  // ===== Init
  (function init() {
    document.getElementById('y').textContent = new Date().getFullYear();
    renderStats();
    drawCharts();
    // pengumuman akan dimuat saat tab Pengumuman diklik
  })();
  </script>
</body>
</html>
